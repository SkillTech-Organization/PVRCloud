SELECT     TPL.ID AS TPL_ID, PTPS.PTP_ORDER, SUM(TOD.TOD_QTY) AS PLQTY, MIN(ISNULL(ORD.ORD_LOCKDATE, 0)) AS LCK, 
                      PTPE.PTP_ORDER AS PTPE_ORDER, SUM(TOD.TOD_VOLUME) AS PLVOL, SUM(PTPA.PTP_TOLL) AS PLTOLL, COUNT(*) AS PLCNT, 
                      SUM(CASE WHEN OTP.OTP_VALUE = 1 THEN TOD.TOD_QTY ELSE 0 END) AS PLQTY_WHSOUT, 
                      SUM(CASE WHEN OTP.OTP_VALUE = 1 THEN TOD.TOD_VOLUME ELSE 0 END) AS PLVOL_WHSOUT, 
                      SUM(CASE WHEN OTP.OTP_VALUE = 4 THEN TOD.TOD_QTY ELSE 0 END) AS PLQTY_DEPOUT, 
                      SUM(CASE WHEN OTP.OTP_VALUE = 4 THEN TOD.TOD_VOLUME ELSE 0 END) AS PLVOL_DEPOUT
FROM         dbo.TPL_TRUCKPLAN AS TPL 
INNER JOIN dbo.PTP_PLANTOURPOINT AS PTPS ON PTPS.TPL_ID = TPL.ID AND PTPS.PTP_TYPE = 0 
INNER JOIN dbo.PTP_PLANTOURPOINT AS PTPE ON PTPE.TPL_ID = TPL.ID AND PTPE.PTP_ORDER =
                          (SELECT     MIN(PTP_ORDER) AS Expr1
                            FROM          dbo.PTP_PLANTOURPOINT AS PTP
                            WHERE      (TPL_ID = TPL.ID) AND (PTP_ORDER > PTPS.PTP_ORDER) AND (PTP_TYPE = 1)) 
INNER JOIN dbo.PTP_PLANTOURPOINT AS PTPA ON PTPA.TPL_ID = TPL.ID AND PTPA.PTP_ORDER >= PTPS.PTP_ORDER AND PTPA.PTP_ORDER <= PTPE.PTP_ORDER 
LEFT OUTER JOIN dbo.TOD_TOURORDER AS TOD ON PTPA.TOD_ID = TOD.ID 
LEFT OUTER JOIN dbo.ORD_ORDER AS ORD ON TOD.ORD_ID = ORD.ID 
LEFT OUTER JOIN dbo.OTP_ORDERTYPE AS OTP ON ORD.OTP_ID = OTP.ID
WHERE    ( OTP.OTP_VALUE is null  (OTP.OTP_VALUE = 1) OR (OTP.OTP_VALUE = 4)) 
GROUP BY TPL.ID, PTPS.PTP_ORDER, PTPE.PTP_ORDER
HAVING SUM(PTPA.PTP_TOLL) > 0
